#version 460
#extension GL_NV_gpu_shader5 : enable
#extension GL_NV_fragment_shader_interlock : enable
layout(pixel_interlock_unordered) in;

uniform layout(binding = 0, rgba32f) readonly image2D momentTex;
uniform layout(binding = 1, rgba32f)   image2D totalMomentTex;
uniform layout(binding = 2, rgba32f) image2D colorTex;
uniform layout(binding = 3, rg32f)  coherent image2D minMaxTex;

float weights1[7][32] = {{-0.34414511919021606,0.12653681635856628,-0.9661073088645935,1.874392032623291,0.05222931504249573,0.2959360182285309,1.1882380247116089,-0.18363350629806519,0.2721109092235565,3.007748603820801,0.6584939360618591,0.019207574427127838,-2.845170259475708,0.7084011435508728,0.03973458707332611,0.987511396408081,-0.9012143015861511,-0.2574462890625,-0.2964651584625244,-5.006521224975586,0.6057344675064087,-0.1521109938621521,1.692777395248413,-0.8740663528442383,-0.5214202404022217,1.186361312866211,-0.11549833416938782,-0.8024656772613525,0.0492573156952858,0.2590906620025635,-0.10006275773048401,1.2585036754608154},{-0.32187142968177795,-0.14311634004116058,0.03882817551493645,0.17495688796043396,-0.18855120241641998,0.0262912604957819,-0.00016224768478423357,-0.371052622795105,-0.3562946617603302,0.4256390333175659,0.11026854068040848,0.10569558292627335,0.2148689478635788,0.09123490005731583,-0.10098198056221008,-0.0005063589196652174,0.3835723102092743,-0.15867486596107483,-0.27843835949897766,0.07246160507202148,0.20840008556842804,0.056736767292022705,0.3478758633136749,0.23980139195919037,0.2430839091539383,0.11029242724180222,-0.2263946682214737,0.2999843657016754,-0.020387616008520126,0.2366955280303955,-0.3341889977455139,0.31728288531303406},{-0.09801346063613892,-0.3710857033729553,0.04244033247232437,-0.10929211229085922,-0.247688889503479,0.19264189898967743,0.3743719160556793,0.2625976502895355,-0.25990909337997437,0.27462661266326904,-0.026941433548927307,0.24668963253498077,-0.27662768959999084,0.19371290504932404,0.106231689453125,-0.17375072836875916,-0.36998647451400757,0.07416859269142151,0.09522464871406555,0.1719110757112503,0.36165159940719604,0.39321425557136536,0.34356802701950073,-0.15670259296894073,0.27249106764793396,-0.14425501227378845,-0.3198436498641968,0.1279013752937317,0.07312281429767609,0.39040085673332214,-0.37680959701538086,-0.11573281139135361},{-0.15338294208049774,0.004320025444030762,0.11072871088981628,-0.32951685786247253,-0.3848963677883148,-0.04905084893107414,0.017724979668855667,-0.35493120551109314,-0.28895455598831177,-0.22696557641029358,0.2376287430524826,0.05673425644636154,-0.2585483491420746,0.27254119515419006,-0.3061668276786804,-0.30095160007476807,0.23307067155838013,-0.2375832051038742,-0.10088682174682617,0.015640495344996452,-0.05399637669324875,0.22479772567749023,-0.10291888564825058,-0.2381521761417389,-0.11284659057855606,0.07375141233205795,0.3239818513393402,-0.210645854473114,0.17889361083507538,-0.5161917805671692,-0.3530619144439697,0.4487018287181854},{-0.3489435911178589,0.21629974246025085,0.3535166084766388,0.16260595619678497,0.21248415112495422,0.15234851837158203,-0.12070880085229874,0.07084786891937256,0.31066396832466125,0.2616177201271057,0.0005256077274680138,-0.049140624701976776,0.15398384630680084,0.27401918172836304,-0.013070824556052685,0.24498969316482544,0.4266050159931183,0.14915913343429565,-0.3834414482116699,-0.03723621740937233,-0.3733740448951721,-0.4018460214138031,-0.1523718386888504,-0.11157052963972092,-0.11900033056735992,-0.18175293505191803,-0.238959401845932,-0.13345476984977722,0.5760523080825806,-0.21060816943645477,-0.07533800601959229,-0.22261865437030792},{-0.2920129597187042,0.1560383141040802,-0.19050712883472443,0.20643259584903717,0.27933862805366516,-0.323093444108963,-0.035098589956760406,-0.12365099787712097,0.33723196387290955,0.37617364525794983,0.3043375611305237,-0.08568626642227173,-0.06382565200328827,0.33213385939598083,0.05881806090474129,0.25617727637290955,0.07532506436109543,0.3330974280834198,0.22278842329978943,0.28099530935287476,-0.38583746552467346,0.39733701944351196,-0.16811762750148773,-0.3248022496700287,-0.08265073597431183,0.3561154305934906,-0.16152888536453247,0.11707030981779099,-0.6205858588218689,0.2862429618835449,-0.3651162385940552,0.08453281968832016},{0.3874058425426483,-0.024920761585235596,-0.21481971442699432,0.05665004625916481,-0.14124396443367004,0.07929093390703201,-0.10457506030797958,0.1777832806110382,-0.3417612314224243,0.12562920153141022,-0.04325534775853157,0.08667165786027908,0.32135069370269775,0.008409949950873852,0.3166237771511078,-0.018587110564112663,-0.3224920928478241,-0.0729677677154541,0.2948395907878876,-0.112495057284832,0.16360695660114288,0.41864365339279175,-0.18696443736553192,0.549834132194519,0.3483012020587921,0.007484259083867073,0.2801351845264435,-0.061697304248809814,-1.230862021446228,0.1544642299413681,0.1081075370311737,0.02041240595281124}};
float bias1[32] = { 0.0000000e+00,  0.0000000e+00,  1.4939924e-01, -2.3840527e-01,
        0.0000000e+00, -4.0897962e-01, -2.1948098e-01,  0.0000000e+00,
        0.0000000e+00,  2.4952285e-01, -2.0849967e-01, -3.3372378e-01,
       -8.5775502e-02, -5.0742060e-01, -6.4369255e-05,  9.9615969e-02,
        2.3134074e-01, -3.7637996e-04,  0.0000000e+00,  2.4462679e-02,
       -4.6428663e-01,  7.4436468e-01, -3.5860747e-01,  2.9511042e-02,
        1.5973332e+00, -3.0973310e-02,  0.0000000e+00,  6.8289417e-01,
        2.4420534e-01,  9.3788683e-01,  0.0000000e+00,  2.5876045e-01 };

float weights2[32][16] = {{0.185664564371109,-0.03614068031311035,0.09530001878738403,0.2365088164806366,0.31710758805274963,-0.3441005349159241,0.10048812627792358,-0.3188329041004181,0.3470103442668915,0.09992343187332153,-0.06578338146209717,0.32533279061317444,-0.10427045822143555,-0.2294023334980011,-0.1496722251176834,-0.1794712245464325},{-0.3521365821361542,-0.01516619324684143,0.3201540410518646,0.248930424451828,-0.2086324542760849,-0.18725262582302094,0.17853066325187683,0.1876901090145111,0.330645889043808,-0.2785826623439789,-0.06260839104652405,0.22865405678749084,-0.14486318826675415,-0.2210785150527954,0.05163636803627014,-0.2702072262763977},{0.40374788641929626,0.14670929312705994,-0.13179220259189606,0.20426398515701294,-0.25460678339004517,-0.4324227273464203,-0.09164305031299591,0.3614422082901001,-0.10924303531646729,0.24084271490573883,-0.21784761548042297,0.19899238646030426,0.14133501052856445,-0.12509320676326752,0.414141982793808,-0.013165002688765526},{-0.5720633864402771,0.10177376866340637,0.08936949819326401,-0.09840825200080872,0.5683372616767883,0.6305904388427734,0.4546931982040405,-0.0890011265873909,-0.341675728559494,-0.23381027579307556,0.10499706864356995,-0.3871687352657318,-0.21135683357715607,-0.06809449195861816,0.06998422741889954,0.49998897314071655},{-0.21671175956726074,0.28371092677116394,0.03559452295303345,-0.09806323051452637,-0.06753736734390259,0.2824144661426544,0.3296045958995819,0.09425351023674011,0.21629807353019714,-0.285579115152359,0.25527921319007874,0.18278178572654724,0.00464940071105957,0.014503657817840576,-0.17860999703407288,0.22198548913002014},{0.044673141092061996,0.19348499178886414,0.0026880770456045866,0.32029077410697937,0.06468763202428818,0.05885766074061394,0.42577382922172546,-0.09315954148769379,-0.2453390657901764,-0.19723433256149292,0.17369404435157776,0.07216714322566986,0.18549731373786926,-0.27586427330970764,-0.01766905188560486,-0.19883902370929718},{-0.8112334609031677,0.08155220746994019,-0.06319564580917358,-0.26100993156433105,0.5645028948783875,0.8595484495162964,0.5896239876747131,-0.49035242199897766,-0.03209415078163147,-0.059053752571344376,-0.2730902433395386,-0.19716814160346985,-0.15701034665107727,-0.2058458775281906,-0.44680777192115784,0.7031675577163696},{0.3529663383960724,0.27829983830451965,-0.10027122497558594,-0.11720255017280579,-0.3149574100971222,-0.09674826264381409,-0.09574702382087708,0.022863149642944336,-0.12724967300891876,-0.23370090126991272,-0.15103575587272644,-0.02243223786354065,0.004393130540847778,0.06640574336051941,-0.13231463730335236,0.03573733568191528},{-0.13957232236862183,-0.05153396725654602,-0.1544622927904129,0.12432241439819336,0.049284160137176514,-0.20588785409927368,0.10384932160377502,0.0704425573348999,-0.14023883640766144,-0.042819857597351074,-0.009093523025512695,-0.18413427472114563,-0.1940704733133316,-0.22058691084384918,0.33327367901802063,0.2832399904727936},{0.226225346326828,-0.019300222396850586,-0.15374086797237396,0.13280902802944183,0.3608919382095337,-0.0756368637084961,0.009094090200960636,-0.15007372200489044,0.0852736234664917,0.07948779314756393,0.18904969096183777,-0.2685317397117615,-0.11818207055330276,0.14726391434669495,0.3067529797554016,-0.10553619265556335},{-0.24669130146503448,-0.00917208194732666,0.07198546081781387,-0.17263653874397278,0.24553412199020386,0.18101520836353302,0.21409524977207184,0.011530660092830658,-0.3013533353805542,0.18417279422283173,0.004292398691177368,-0.34486570954322815,-0.16388574242591858,0.22058464586734772,-0.1843826323747635,0.15965543687343597},{0.21491536498069763,0.03806063532829285,0.21471266448497772,-0.3142049312591553,-0.39999184012413025,0.2202911376953125,0.17024458944797516,-0.19889254868030548,0.22052374482154846,0.011872278526425362,-0.32123205065727234,0.12627972662448883,-0.23743879795074463,-0.24571122229099274,-0.06294136494398117,-0.24203559756278992},{-0.14427822828292847,-0.029422134160995483,0.26773566007614136,-0.31380271911621094,-0.14928780496120453,0.17036288976669312,0.0018895177636295557,0.04464297741651535,0.2756127417087555,-0.07911888509988785,-0.1441815048456192,0.51991206407547,-0.2506139278411865,0.14721600711345673,0.17983238399028778,0.02093791589140892},{-0.26052868366241455,0.054827481508255005,-0.13254758715629578,-0.1268930584192276,0.013528810814023018,0.07317343354225159,0.35891053080558777,0.2922738492488861,0.0015554726123809814,-0.09074994176626205,-0.27513545751571655,-0.344824880361557,-0.3062012791633606,0.04071423038840294,0.1761396825313568,-0.09331418573856354},{-0.16568364202976227,0.010249525308609009,0.32791265845298767,-0.3139815330505371,0.2733117341995239,-0.27236607670783997,-0.0433332659304142,0.016281278803944588,0.31352493166923523,-0.01054033637046814,0.145511656999588,-0.04937747120857239,0.002755969762802124,-0.013565992936491966,-0.10219595581293106,-0.34716635942459106},{1.105865240097046,-0.005618840456008911,-0.1892758011817932,-0.06014571338891983,-0.6376221179962158,-0.5949438214302063,0.8636972308158875,0.7798341512680054,-0.3508777320384979,-0.4437805116176605,0.20337870717048645,3.9656589031219482,-0.23678478598594666,0.14106805622577667,0.4751230478286743,0.5957961082458496},{0.5205371975898743,-0.16538043320178986,-0.14936065673828125,0.25671467185020447,0.08007185161113739,-0.39106184244155884,-0.1424276977777481,0.3214482069015503,0.11554718017578125,0.29545480012893677,0.3178148567676544,0.29491913318634033,-0.28587058186531067,-0.280037522315979,-0.18269965052604675,0.20235265791416168},{0.23896226286888123,0.3364904224872589,-0.3056688606739044,-0.1065099686384201,0.35106366872787476,-0.26054680347442627,-0.05472976714372635,-0.2814064621925354,-0.11339862644672394,0.002495255321264267,-0.0008700788021087646,0.14171987771987915,0.1456708014011383,0.25295037031173706,-0.13738328218460083,-0.043209463357925415},{-0.21267004311084747,0.23496684432029724,-0.16474881768226624,0.1877622902393341,-0.29101312160491943,-0.15160271525382996,0.3259831964969635,-0.32226693630218506,0.2704956829547882,0.3205055296421051,0.28411349654197693,0.31001409888267517,0.137985497713089,0.09342378377914429,-0.1965540200471878,-0.24547579884529114},{0.31914380192756653,0.16168871521949768,0.1449633687734604,-0.21709086000919342,-0.5650798678398132,-0.5992188453674316,-0.11147082597017288,0.43536385893821716,-0.01325923204421997,0.033828213810920715,-0.2010091096162796,3.0052566528320312,0.2515096366405487,-0.09015274792909622,0.6602584719657898,-1.094861388206482},{-0.13377645611763,0.01144784688949585,-0.23306314647197723,0.04731767252087593,0.37120935320854187,0.1588423103094101,0.38412195444107056,-0.2901107668876648,-0.03608578443527222,-0.10874158889055252,-0.12395346164703369,0.1787678748369217,-0.2391313910484314,0.05143159255385399,-0.16546516120433807,-0.09163683652877808},{-0.2234116941690445,-0.292667031288147,0.19687409698963165,-0.29828500747680664,0.11225023120641708,0.13110561668872833,-0.4546242952346802,0.3614683151245117,-0.2708026170730591,-0.25315022468566895,-0.1311223804950714,-0.07505957037210464,0.2061714082956314,0.10575785487890244,-0.16155947744846344,0.1082611158490181},{0.09971205145120621,-0.05324840545654297,-0.3258764147758484,-0.16896319389343262,0.01846238225698471,-0.02388004958629608,0.04714580252766609,0.3420277237892151,-0.21451210975646973,0.1419394612312317,-0.11157602071762085,-0.3415161073207855,-0.20035108923912048,-0.1979675441980362,0.3779534697532654,-0.3201356530189514},{-0.11280155926942825,0.1515495479106903,0.13606609404087067,-0.28482621908187866,-0.3588148057460785,0.18500173091888428,-0.06528899818658829,0.13547950983047485,-0.32967668771743774,-0.14282011985778809,-0.2117699533700943,0.29927486181259155,-0.11112665385007858,-0.05740857124328613,-0.04126777499914169,-0.23065023124217987},{0.30618157982826233,0.06675007939338684,0.1109197661280632,-0.1370997279882431,0.09781087934970856,0.1982264518737793,-0.19602376222610474,0.12314831465482712,-0.2988779544830322,-0.04498586058616638,0.11058345437049866,-0.06348245590925217,-0.09244006872177124,-0.15785081684589386,-0.13610337674617767,-0.06932388991117477},{-0.6300456523895264,-0.08359566330909729,-0.31246569752693176,0.2677687406539917,0.1510651409626007,0.8208150267601013,0.17406338453292847,-0.26667851209640503,0.09143978357315063,-0.015803705900907516,-0.28306448459625244,-0.22869078814983368,-0.265480637550354,-0.0018169512040913105,-0.7596381306648254,0.3480047583580017},{-0.15089397132396698,0.2727380096912384,0.165298730134964,-0.09951865673065186,0.10278335213661194,0.29743167757987976,-0.017609894275665283,-0.04735904932022095,0.019176483154296875,0.07586964964866638,0.24774262309074402,-0.3036477267742157,-0.14061984419822693,-0.04106840491294861,-0.26146116852760315,-0.24448618292808533},{-0.05264870449900627,-0.10426464676856995,0.10059718042612076,0.1338667869567871,-0.19240911304950714,0.20699705183506012,-0.26388832926750183,-0.05531784147024155,-0.29485252499580383,-0.30677977204322815,0.07126128673553467,-0.23849517107009888,-0.0709763914346695,-0.176118865609169,0.4151475727558136,-0.22009731829166412},{1.3854951858520508,0.09412461519241333,0.22529806196689606,-0.09245416522026062,-0.18316417932510376,-0.194209486246109,0.19841238856315613,-1.5991560220718384,-0.24099373817443848,0.03740701451897621,-0.2575795352458954,0.07523856312036514,0.24715420603752136,0.23703452944755554,0.6492182016372681,0.4488943815231323},{-0.21457237005233765,-0.3127441108226776,-0.027436884120106697,0.22119992971420288,0.24270346760749817,-0.20623981952667236,-0.3695838153362274,-0.28283604979515076,-0.19283877313137054,0.23756355047225952,-0.34854239225387573,-0.1288258582353592,0.3273598253726959,-0.3403528928756714,-0.15578541159629822,0.27181363105773926},{-0.3022029399871826,0.12880387902259827,0.21572771668434143,-0.28307172656059265,-0.06327623128890991,-0.214925155043602,-0.10313054919242859,0.1828794777393341,-0.005233973264694214,0.2530880868434906,0.16224530339241028,-0.023603498935699463,-0.24551339447498322,-0.021862328052520752,-0.3032085597515106,0.2620498239994049},{0.33207446336746216,-0.152696430683136,-0.12176887691020966,-0.1530858725309372,0.33038103580474854,0.10120982676744461,0.0931030809879303,0.02472873218357563,-0.1925787329673767,-0.15339475870132446,-0.30211973190307617,-0.1845838874578476,-0.12055908888578415,0.11165494471788406,-0.028836145997047424,0.41534391045570374}};
float bias2[16] =  {  0.271928  ,  0.        , -0.08522157, -0.00978797, -0.09353104,
       -0.02293135, -2.0875304 ,  0.01962615,  0.        , -0.03775575,
        0.        ,  0.28011847, -0.00782661, -0.01380131,  0.14691024,
        0.2778654};

float weights3[16][1] = {{0.7547224164009094},{-0.089885413646698},{-0.26306506991386414},{-0.2136279046535492},{-0.38419994711875916},{-0.884917140007019},{-7.530893802642822},{0.6859511733055115},{0.5868613719940186},{-0.4697877764701843},{-0.4362373352050781},{12.480789184570312},{-0.40156105160713196},{-0.0873088464140892},{0.4552827775478363},{1.3984721899032593}};
float bias3[1] = {0.08083689};

float sigmoid(float x){
	return 1.0f / (1.0f + exp(-x));
}

float relu(float x){
	return max(0.0f,x);
}

vec4 computeColor(){} //Generic color function

void main(void) {

	ivec2 coords=ivec2(gl_FragCoord.xy);

	beginInvocationInterlockNV();

	vec4 bt = imageLoad(totalMomentTex, coords);
	
	float b0 = bt.r;
	float frags = bt.b;	   
	   
    	if (b0 < 0.00100050033f) {
        	discard;
    	}
	
	float total_transmittance = exp(-b0);
	vec4 moments14 = imageLoad(momentTex, coords);
	
	vec4 prevMinMaxDepths = imageLoad(minMaxTex, coords);
	float t_depth = (exp(gl_FragCoord.z) - exp(prevMinMaxDepths.r)) / (exp(prevMinMaxDepths.g) - exp(prevMinMaxDepths.r));
	float inp[1][7] = {{t_depth,frags,b0,moments14[0],moments14[1],moments14[2],moments14[3]}};

	float rslt[32];
 
	int C1 = 7;
	int R2 = 7;
	int C2 = 32;
    
	for (int j = 0; j < C2; j++) {
		rslt[j] = 0;
		for (int k = 0; k < R2; k++) {
			rslt[j] += inp[0][k] * weights1[k][j];
		}
		rslt[j] = relu(rslt[j] + bias1[j]);
	}   
    
	float rslt2[16];
   
	C1 = 32;
  	R2 = 32;
   	C2 = 16;

    
	for (int j = 0; j < C2; j++) {
		rslt2[j] = 0;
		for (int k = 0; k < R2; k++) {
			rslt2[j] += rslt[k] * weights2[k][j];
		}
		rslt2[j] = relu(rslt2[j] + bias2[j]);
	} 
	
   	C1 = 16;
   	R2 = 16;
   	C2 = 1;
   
	for (int j = 0; j < C2; j++) {
		rslt[j] = 0;	
		for (int k = 0; k < R2; k++) {
			rslt[j] += rslt2[k] * weights3[k][j];
		}
		rslt[j] = sigmoid(rslt[j] + bias3[j]);
	}

	float transmittance_at_depth  = rslt[0];	
	float prevTras = bt.g;

	bt = vec4(b0,prevTras + alpha*transmittance_at_depth,bt.b,0);

	vec4 color = transmittance_at_depth*computeColor()*alpha; 

	vec4 prevColor = imageLoad(colorTex, coords);
	prevColor = prevColor + color;

	imageStore(colorTex,coords,prevColor);
	imageStore(totalMomentTex, coords,bt); //store b0

	endInvocationInterlockNV();
}